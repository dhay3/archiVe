# Nmap 02 - Zombie scan



## 0x01 Overview

Zombie scan 也被称为 idle scan，可以让攻击者通过 zombie’s IPID 来判断目的主机端口的状态

TCP/IP 中有如下规则

1. One way to determine whether a TCP port is open is  to send a SYN (session establishment) packet to the port.  The  target machine will respond with a SYN/ACK (session request  acknowledgment) packet if the port is open, and RST (reset) if the  port is closed.  This is the basis of the previously discussed SYN  scan.
2. A machine that receives an unsolicited SYN/ACK  packet will respond with a RST. An unsolicited RST will be  ignored.
3. Every IP packet on the Internet has a fragment  identification number  (IP ID).  Since many operating systems simply  increment this number for each packet they send, probing for  the IPID can tell an attacker how many packets have been sent  since the last probe.

3 层报文中有一个 IPID 字段主要被用于分片中表示分片的报文同属一个包，方便分片在目的端重组。除分片外主机每发送一个 3 层报文，IPID 就会加一

因为 IPID 的这种特性，就允许如下方式来探测端口的状态

1. Probe the zombie's IP ID and record it.

   先探测 zombie’s IPID 并记录

2. ==Forge a SYN packet from the zombie and send it to the desired port on the target(SYN 报文是伪造的，实际还是从攻击机发出，但是目的机认为是 zombie 发出的)==. Depending on the port state, the target's reaction may or may not cause the zombie's IP ID to be incremented.

   伪造 zombie SYN 报文，根据目的端口的状态，会影响 zombie IPID 是否增长

3. Probe the zombie's IP ID again. The target port state is then determined by comparing this new IP ID with the one recorded in step 1.

   对比第一步和第二步记录的 zombie’s IPID

   可能会出现如下 3 种情况

   - An increase of one indicates that the zombie hasn't sent out any packets, except for its reply to the attacker's probe. This lack of sent packets means that the port is not open (the target must have sent the zombie either a RST packet, which was ignored, or nothing at all).

     如果 zombie’s IPID 只增加了 1，就表示目的端口不是 open 状态的（zombie 收到了目的回送的 RST，或者是没有收到报文，zombie host 没有回送给目的任何报文，即 zombie 只发送了 “SYN”，IPID 加 1）

     所以 zombie’s IPID 增加 1 并不能区别目的端口是 closed 或者是 filtered，所以 Nmap 将其标记为 closed|filtered

   - An increase of two indicates that the zombie sent out a packet between the two probes. This extra packet usually means that the port is open (the target presumably sent the zombie a SYN/ACK packet in response to the forged SYN, which induced a RST packet from the zombie).

     如果 zombie’s IPID 增加了 2，就表示目的端口是 open 状态的(zombie 收到来目的回送的 SYN/ACK, zombie 回送给目的 RST，即 zombie 发送了 “SYN” 和 RST，IPID 加 2)

   - Increases larger than two usually signify a bad zombie host.  It might not have predictable IP ID numbers, or might be engaged in communication unrelated to the idle scan.

     如果 zombie’s IPID 增加大于 2，就表示 zombie 可能和其他的主机在做 3 层通信或者 zombie TCP/IP 中 IPID 递增不是全局的(例如 Solaris)

## 0x02 Anatomy

为了更好的理解 zombie scan 工作的原理，请参考下面的例子

![img](https://nmap.org/book/images/idle-scan-attacker.png) the attacker,  ![img](https://nmap.org/book/images/idle-scan-zombie.png) the zombie, and ![img](https://nmap.org/book/images/idle-scan-target.png) the target.

> 在这里并不是随意使用 printer icon 作为 zombie host
>
> 因为 printer 通常在没有打印的任务下都没有其他流量，很适合做 zombie

### Idle scan of an open port

![Step 1: The attacker sends a SYN/ACK to the zombie. The zombie, not expecting the SYN/ACK, sends back a RST, disclosing its IP ID. Step 2: The target sends a SYN/ACK in response to the SYN that appears to come from the zombie. The zombie, not expecting it, sends back a RST, incrementing its IP ID in the process. The zombie's IP ID has increased by two since step 1, so the port is open!](https://nmap.org/book/images/idle-scan-open.png)

1. 攻击者会先向 zombie 发送 SYN/ACK，因为不合符 TCP/IP 规则，zombie 会回送 RST，同时包含 zombie IPID
2. 攻击者向目的发送伪造 zombie SYN 报文，目的回送 SYN/ACK，因为 zombie 实际没有没发送 SYN，所以不符合 TCP/IP 规则，zombie 回送 RST，zombie IPID 加 1
3. 攻击者向 zombie 发送 SYN/ACK, 因为不符合 TCP/IP 规则，zombie 会回送 RST，同时 zombie IPID 加 1

### Idle scan of a closed port

![Step 1: The attacker sends a SYN/ACK to the zombie. The zombie, not expecting the SYN/ACK, sends back a RST, disclosing its IP ID. This step is always the same. Step 2: The target sends a RST (the port is closed) in response to the SYN that appears to come from the zombie. The zombie ignores the unsolicited RST, leaving it IP ID unchanged. Step 3: The zombie's IP ID has increased by only one since step 1, so the port is not open.](https://nmap.org/book/images/idle-scan-closed.png)

1. 攻击者会先向 zombie 发送 SYN/ACK，因为不合符 TCP/IP 规则，zombie 会回送 RST，同时包含 zombie IPID
2. 攻击者向目的发送伪造 zombie SYN 报文，目的回送 RST，zombie 不做任何反应，zombie IPID 不变
3. 攻击者向 zombie 发送 SYN/ACK, 因为不符合 TCP/IP 规则，zombie 会回送 RST，同时 zombie IPID 加 1

### Idle scan of a filtered port

![Step 1: Just as in the other two cases, the attacker sends a SYN/ACK to the zombie. The zombie disclosed its IP ID. Step 2: The target, obstinately filtering its port, ignores the SYN that appears to come from the zombie. The zombie, unaware that anything has happened, does not increment its IP ID. Step 3: The zombie's IP ID has increased by only 1 since step 1, so the port is not open. From the attacker's point of view this filtered port is indistinguishable from a closed port.](https://nmap.org/book/images/idle-scan-filtered.png)

1. 攻击者会先向 zombie 发送 SYN/ACK，因为不合符 TCP/IP 规则，zombie 会回送 RST，同时包含 zombie IPID
2. 攻击者向目的发送伪造 zombie SYN 报文，目的回送没有回送任何报文，zombie 不做任何反应，zombie IPID 不变
3. 攻击者向 zombie 发送 SYN/ACK, 因为不符合 TCP/IP 规则，zombie 会回送 RST，同时 zombie IPID 加 1

## 0x03 Finding a Working Idle Scan Zombie Host

zombie scan 最重要的一步就是找 zombie host，一个完美的 zombie host 需要具备如下几点

1. It needs to assign IP ID packets incrementally on a global (rather than per-host it communicates with) basis.

   IPID 需要全局增长，而不是每个通信的主机单独 IPID

   Linux 内核的主机均符合该要求

2. It should be idle (hence the scan name), as extraneous traffic will bump up its IP ID sequence, confusing the scan logic.

   zombie 最好没有除 Nmap 扫描外的流量

3. The lower the latency between the attacker and the zombie, and between the zombie and the target, the faster the scan will proceed.

   zombie/attacker/target 3 者之间的延时尽量低

## 0x04 Excuting an Idle Scan



**references**

[^1]:https://nmap.org/book/idlescan.html