# Nmap 02 - Host Discovery

## 0x01 Overview

*By default, Nmap will include a ping scanning stage prior to more intrusive probes such as port scans, OS detection, Nmap Scripting Engine, or version detection.*

Nmap 在进行 port scans, OS detection, NSE 或者 version detection (统称 intrusive probes )前先会做 host discovery，用于发现那些 hosts 是在线的，或者那些 hosts 是你感兴趣的。Nmap 只会对 host dicovery 阶段发现的在线 hosts 做 intrusive probes，相对 full scans against every single IP address 这会节省大量的时间和带宽

## 0x02 Finding an Organization’s IP Addresses

通常在对一个组织做扫描前，你可能只会拿到他们的域名，我们需要将域名转为组织对应的 netblocks （现在大多数服务都会使用 DNS 最后获取到的 netblocks 不一定对应实际服务的 IP, 如果需要反查 CDN 可以通过 https://search.censys.io/，结果不一定对）

可以通过如下几种方式

1. 通过 netcraft 提供的 searchdns 服务 https://searchdns.netcraft.com/?host

2. 使用 `whois <IP address>`


## 0x03 Best host discovery probes

下面 2 张表提供了成功率最高的探测方式，可以结合实际选择

### Best host discovery probes

| Hosts found | Probe                                        |
| ----------: | :------------------------------------------- |
|      62.47% | `-PE`                                        |
|      44.17% | `-PS443`                                     |
|      43.28% | `-PA80`                                      |
|      43.01% | `-PA443`                                     |
|      42.47% | `-PS80`                                      |
|      40.65% | `-PA110`                                     |
|      40.42% | `-PA3389`                                    |
|      40.41% | `-PS110`                                     |
|      39.89% | `-PA22`                                      |
|      39.62% | `-PS21`                                      |
|      39.62% | `-PA21`                                      |
|      38.75% | `-PS22`                                      |
|      37.50% | `-PS3389`                                    |
|      36.66% | `-PP`                                        |
|      31.17% | `-PU40125 --source-port 53 --data-length 24` |
|      29.96% | `-PU31338 --source-port 53 --data-length 24` |
|      29.05% | `-PU631 --source-port 53 --data-length 24`   |
|      26.38% | `-PU40125`                                   |
|      26.09% | `-PS25`                                      |
|      25.69% | `-PA25`                                      |
|      25.35% | `-PU31338`                                   |
|      24.71% | `-PU631`                                     |
|      24.15% | `-PU53 --source-port 53 --data-length 24`    |
|      22.20% | `-PU53`                                      |
|       9.09% | `-PO2`                                       |
|       9.03% | `-PO150`                                     |
|       7.20% | `-PO4`                                       |
|       4.21% | `-PM`                                        |

### Best host discovery probe combinations

|          | Hosts found | Probe combination                                            |
| :------- | :---------: | :----------------------------------------------------------- |
| 1 probe  |   62.47%    | `-PE`                                                        |
| 2 probes |   77.61%    | `-PE -PA80`                                                  |
| 3 probes |   83.83%    | `-PE -PA80 -PS443`                                           |
| 4 probes |   88.64%    | `-PE -PA80 -PS443 -PP`                                       |
| 5 probes |   91.12%    | `-PE -PA80 -PS443 -PP -PU40125 --source-port 53`             |
| 6 probes |   92.42%    | `-PE -PS80 -PS443 -PP -PU40125 -PA3389 --source-port 53`     |
| 7 probes |   93.10%    | `-PE -PS80 -PS443 -PP -PU40125 -PS3389 -PA21 --source-port 53` |
| 8 probes |   93.69%    | `-PE -PS80 -PS443 -PP -PU40125 -PS3389 -PA21 -PU161 --source-port 53` |

**references**

[^1]:https://nmap.org/book/host-discovery.html