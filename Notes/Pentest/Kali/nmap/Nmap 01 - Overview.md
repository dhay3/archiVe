# Nmap 01 - Overview

## 0x01 Overview

*Nmap (“Network Mapper”) is a free and open source utility for network exploration and security auditing.*

Nmap(“Network Mapper”) 是一个网络探测工具，在使用它之间至少需要了解掌握 TCP/IP

另外强烈推荐阅读 Demos[^2]

## 0x02 Nmap Reference Guide

> 可以使用 GUI zenmap
>
> 所有测试均在关闭 Clash tun 的情况下

这里只记录 IPv4 的常见用法，具体还请参考[^1]

### CLI Synopsis

```
nmap [<Host Discovery> ...] [ <Port Scan> ...] [ <Options> ... ] { <Target Specification> }
```

Nmap CLI 可以拆解成如下 4 部分

1. Host Discovery

   主机发现

2. Port scan

   端口扫描模式

3. Options

   杂项

4. Target Specification

   用于描述扫描目标

### Target Specification

target specification 描述探测目标，有如下几种格式

1. CIDR notaion

   例如 `192.168.10.0/24` 表示 `192.168.10.0` - `192.168.10.255`

2. Octet range

   例如 `192.168.0-255.1-254` 表示 `192.168.0.1` - `192.168.255.254`

   例如 `192.168.3-5,7.1` 表示 `192.168.3.1`, `192.168.4.1`, `192.168.5.7`, `192.168.7.1`

   如果单独使用 `-` 即表示 `0-255`，例如 `192.168.1.-` 表示 `192.168.1.0` - `192.168.1.255`

3. domain name

   例如 `scanme.nmap.org`

   如果有多条 DNS A records， Nmap 只会使用解析出来的第一条

   如果要想使用所有的 DNS A records， 需要使用 `--resolve-all`

通常 target 只需要在命令行声明即可，例如 `nmap scanme.nmap.org 192.168.0.0/8 10.0.0,1,3-7.-`

但是 Nmap 也支持使用参数来控制 target

- `-iL <filename>`

  从文件中读取 target，使用 space,tab,newline

  使用 `#` 表示注释 

- `-iR <num>`

  随机使用 num 数量的地址作为 target

  0 表示 never-ending scan

  通常用于研究测试

- `--exclude <host1>[,<host2>[,...]]`

  排除指定的 target

- `--excludefile <exclude_file>`

  和 `--exclude` 逻辑相同，但是从文件中读取

- `-n`

  不使用 reverse DNS resolution 对 IP 地址反向解析

  Nmap 默认会做 reverse DNS resolution，使用该参数可以有效减少扫描的时间

- `-R`

  对所有 IP 地址做反向解析

- `--resolve-all`

  使用 domain name 或者是 hostname 所有的 A records 作为 target

  Nmap 默认只会使用第一条记录

- `--unique`

  对 target 去重，默认启用

- `--dns-servers <server1>[,<server2>[,...]]`

  使用指定的 dns-server

  Nmap 默认会使用 `/etc/resolve.conf` 中的 DNS server

### Host Discovery

*By default, Nmap will include a ping scanning stage prior to more intrusive probes such as port scans, OS detection, Nmap Scripting Engine, or version detection.*

Nmap 在进行 port scans, OS detection, NSE 或者 version detection (统称 intrusive probes )前，Nmap 默认先会做 host discovery，用于发现那些 hosts 是在线的，或者那些 hosts 是你感兴趣的。Nmap 只会对 host dicovery 阶段发现的在线 hosts 做 intrusive probes，相对 full scans against every single IP address 这会节省大量的时间和带宽

在使用 nmap 时默认会做 2 步

1. host discovery

   主机发现，有利于大范围网络扫描前发现存活的主机

2. port scan

   端口扫描，默认为常见端口，可以使用 `-p<port list>` 来扫描指定的端口

If no host discovery options are given, Nmap sends an ICMP echo request, a TCP SYN packet to port 443, a TCP ACK packet to port 80, and an ICMP timestamp request.

如果没有指定任何 discovery options，nmap 默认会发送 4 种报文，用于 host discovery

1. an ICMP echo request
2. an ICMP timestamp request
3. TCP SYN to port 443
4. TCP ACK to port 80

> 即等价于 `-PP -PE -PS443 -PA80`
>
> 所以通常从在 host discovery 时无需指定其他参数

```
$ sudo nmap -n 10.0.3.75
Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-25 17:10 CST
Nmap scan report for 10.0.3.75
Host is up (0.00028s latency).
Not shown: 997 closed tcp ports (reset)
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https

#以下忽略 port scan 报文
$ sudo tcpdump -nni enp4s0 -c 100 host 10.0.3.75
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
17:10:29.188776 IP 10.100.4.222 > 10.0.3.75: ICMP echo request, id 3952, seq 0, length 8
17:10:29.188790 IP 10.100.4.222.40087 > 10.0.3.75.443: Flags [S], seq 3128031588, win 1024, options [mss 1460], length 0
17:10:29.188797 IP 10.100.4.222.40087 > 10.0.3.75.80: Flags [.], ack 3128031588, win 1024, length 0
17:10:29.188803 IP 10.100.4.222 > 10.0.3.75: ICMP time stamp query id 35022 seq 0, length 20
```

host discovery 可以是如下参数，同时参数之间可以互相组合来增加 host dicovery 成功的几率，例如 `-PP -PS22`

- `-sL`

  ==list scan==

  The list scan is a degenerate form of host discovery that simply lists each host of the network(s) specified, without sending any packets to the target hosts

  不向目标主机发送任何报文(不会做 port scan)，只列出 target，并作 reverse DNS resolution (==对 target 做 reverse DNS resolution 是 Nmap 的默认行为==)

  入侵程度最小，通常被用于告诉用户那些地址会被做扫描

  例如

  ```
  sudo nmap -sL 10.0.3.75
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-25 17:18 CST
  Nmap scan report for 10.0.3.75
  Nmap done: 1 IP address (0 hosts up) scanned in 16.50 seconds
  ```

  如果 host 没有对应的 PTR record(reverse DNS) 会被标识为 down

  还可以直接使用域名，例如 `nmap -sL www.stanford.edu/28`

- `-sn`

  ==no port scan==

  This option tells Nmap not to do a port scan after host discovery, and only print out the available hosts that responded to the host discovery probes

  通常也被称为 ping scan，执行完 host discovery 不会执行 port scan 的操作

  这里可以观察到同时会按照 NIC MAC OUI 判断 vendor 可以通过 https://maclookup.app/ 来校验

  ```
  $ sudo nmap -sn 10.0.1.75
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-25 15:45 CST
  Nmap scan report for 10.100.4.7
  Host is up (0.00018s latency).
  MAC Address: D8:CB:8A:CA:80:52 (Micro-Star Intl)
  Nmap done: 1 IP address (1 host up) scanned in 0.14 seconds
  ```
  
  在 root privilege 下 Nmap 会同时发送 ICMP echo request，TCP SYN to 443, TCP ACK to 80

  例如执行 `sudo nmap -sn 10.0.1.75`

  ```
  $ sudo tcpdump -nni enp4s0 host 10.0.1.75
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  16:38:31.649022 IP 10.100.4.222 > 10.0.1.75: ICMP echo request, id 46650, seq 0, length 8
  16:38:31.649040 IP 10.100.4.222.40994 > 10.0.1.75.443: Flags [S], seq 2251989361, win 1024, options [mss 1460], length 0
  16:38:31.649047 IP 10.100.4.222.40994 > 10.0.1.75.80: Flags [.], ack 2251989361, win 1024, length 0
  16:38:31.649053 IP 10.100.4.222 > 10.0.1.75: ICMP time stamp query id 8051 seq 0, length 20
  16:38:31.652519 IP 10.0.1.75 > 10.100.4.222: ICMP echo reply, id 46650, seq 0, length 8
  16:38:31.652520 IP 10.0.1.75.443 > 10.100.4.222.40994: Flags [S.], seq 2630387391, ack 2251989362, win 29200, options [mss 1460], length 0
  16:38:31.652552 IP 10.100.4.222.40994 > 10.0.1.75.443: Flags [R], seq 2251989362, win 0, length 0
  16:38:31.652579 IP 10.0.1.75 > 10.100.4.222: ICMP time stamp reply id 8051 seq 0: org 00:00:00.000, recv 08:38:31.648, xmit 08:38:31.648, length 20
  16:38:31.652580 IP 10.0.1.75.80 > 10.100.4.222.40994: Flags [R], seq 2251989361, win 0, length 0
  ```
  
  在非 root privilege 下 Nmap 只会发送 TCP SYN to 443 and 80

  例如执行 `nmap -sn 10.0.1.75`

  ```
  $ sudo tcpdump -nni enp4s0 host 10.0.1.75
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  16:39:08.230451 IP 10.100.4.222.44498 > 10.0.1.75.80: Flags [S], seq 604562459, win 24820, options [mss 1460,sackOK,TS val 1035018974 ecr 0,nop,wscale 11], length 0
  16:39:08.230466 IP 10.100.4.222.55206 > 10.0.1.75.443: Flags [S], seq 4188860808, win 24820, options [mss 1460,sackOK,TS val 1035018974 ecr 0,nop,wscale 11], length 0
  16:39:08.240405 IP 10.0.1.75.80 > 10.100.4.222.44498: Flags [S.], seq 321858147, ack 604562460, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
  16:39:08.240405 IP 10.0.1.75.443 > 10.100.4.222.55206: Flags [S.], seq 3204850405, ack 4188860809, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0
  16:39:08.240427 IP 10.100.4.222.44498 > 10.0.1.75.80: Flags [.], ack 1, win 13, length 0
  16:39:08.240440 IP 10.100.4.222.55206 > 10.0.1.75.443: Flags [.], ack 1, win 13, length 0
  16:39:08.240446 IP 10.100.4.222.44498 > 10.0.1.75.80: Flags [R.], seq 1, ack 1, win 13, length 0
  16:39:08.240459 IP 10.100.4.222.55206 > 10.0.1.75.443: Flags [R.], seq 1, ack 1, win 13, length 0
  ```
  
  需要注意的一点是，即使主机的 80 443 端口是 closed，也会显示 host up，==即只要收到表示端口非关闭的报文即认为 host up==

  ```
  nmap -sn 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-25 16:43 CST
  Stats: 0:00:14 elapsed; 0 hosts completed (0 up), 1 undergoing Ping Scan
  Parallel DNS resolution of 1 host. Timing: About 0.00% done
  Stats: 0:00:16 elapsed; 0 hosts completed (0 up), 1 undergoing Ping Scan
  Parallel DNS resolution of 1 host. Timing: About 0.00% done
  Nmap scan report for 10.0.3.49
  Host is up (0.00035s latency).
  Nmap done: 1 IP address (1 host up) scanned in 16.50 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  16:43:12.448645 IP 10.100.4.222.36126 > 10.0.3.49.80: Flags [S], seq 3405736385, win 24820, options [mss 1460,sackOK,TS val 3994403968 ecr 0,nop,wscale 11], length 0
  16:43:12.448659 IP 10.100.4.222.56198 > 10.0.3.49.443: Flags [S], seq 3484123507, win 24820, options [mss 1460,sackOK,TS val 3994403968 ecr 0,nop,wscale 11], length 0
  16:43:12.448985 IP 10.0.3.49.443 > 10.100.4.222.56198: Flags [R.], seq 0, ack 3484123508, win 0, length 0
  16:43:12.449021 IP 10.0.3.49.80 > 10.100.4.222.36126: Flags [R.], seq 0, ack 3405736386, win 0, length 0
  ```
  
- `-Pn`

  ==no ping(host discovery)==

  This option skips the host discovery stage altogether. By default, Nmap only performs heavy probing such as port scans, version detection, or OS detection against hosts that are found to be up. Disabling host discovery with `-Pn` causes Nmap to attempt the requested scanning functions against every target IP address specified.  

  在 host discovery 后，Nmap 默认只会对 up host 做 port scan。可以使用 `-Pn` 来跳过 host discovery 阶段，让 nmap 对所有指定的地址都做 port scan
  
  使用 `nmap 10.0.3.47,49` 扫描，可以看到输出 `1 host up` 对应 10.0.3.49
  
  ```
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 10:24 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00028s latency).
  Not shown: 998 closed tcp ports (conn-refused)
  PORT     STATE SERVICE
  22/tcp   open  ssh
  3306/tcp open  mysql
  
  Nmap done: 2 IP addresses (1 host up) scanned in 12.23 seconds
  ```
  
  如果使用 `-Pn` 可以看到 `2 host up`，表明 Nmap 将 10.0.3.47 也作为 up host 执行 port scan
  
  ```
  nmap -Pn 10.0.3.47,49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 10:25 CST
  Nmap scan report for 10.0.3.47
  Host is up.
  All 1000 scanned ports on 10.0.3.47 are in ignored states.
  Not shown: 1000 filtered tcp ports (no-response)
  
  Nmap scan report for 10.0.3.49
  Host is up (0.00032s latency).
  Not shown: 998 closed tcp ports (conn-refused)
  PORT     STATE SERVICE
  22/tcp   open  ssh
  3306/tcp open  mysql
  
  Nmap done: 2 IP addresses (2 hosts up) scanned in 20.62 seconds
  ```
  
  具体可以抓包对比
  
  在可以确定主机就是存活的情况下，可以使用该参数，减少时间

- `-PS<port list>`

  TCP SYN ping(host dicovery)

  ==注意该参数只针对 host dicovery 阶段，在 port scan 该发什么报文还是发什么报文，所以不能和 `-Pn` 一起使用，可以和 `-sn` 一起使用表示只做 SYN host discovery==

  This option sends an empty TCP packet with the SYN flag set

  使用 SYN 做探测包，默认会使用 80 端口。`-PS` 和 `<port list>` 之间不能有空格，例如 `-PS22,3306,6000-7000`

  1. 当对端端口关闭时，会收到 RST，断开连接
  2. 当对端端口开启时，会收到 SYN-ACK，使用 Nmap 的主机会回送 RST 来终止连接

  ```
  $ sudo nmap -PS22,5000 -p 22,5000 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 10:53 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00040s latency).
  
  PORT     STATE  SERVICE
  22/tcp   open   ssh
  5000/tcp closed upnp
  
  Nmap done: 1 IP address (1 host up) scanned in 16.52 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  10:53:49.044849 IP 10.100.4.222.42314 > 10.0.3.49.22: Flags [S], seq 1138828549, win 24820, options [mss 1460,sackOK,TS val 2886617972 ecr 0,nop,wscale 11], length 0
  10:53:49.044866 IP 10.100.4.222.38704 > 10.0.3.49.5000: Flags [S], seq 2428474934, win 24820, options [mss 1460,sackOK,TS val 2886617972 ecr 0,nop,wscale 11], length 0
  10:53:49.045189 IP 10.0.3.49.22 > 10.100.4.222.42314: Flags [S.], seq 2237944101, ack 1138828550, win 28960, options [mss 1460,sackOK,TS val 1201614448 ecr 2886617972,nop,wscale 7], length 0
  10:53:49.045212 IP 10.100.4.222.42314 > 10.0.3.49.22: Flags [.], ack 1, win 13, options [nop,nop,TS val 2886617973 ecr 1201614448], length 0
  10:53:49.045222 IP 10.100.4.222.42314 > 10.0.3.49.22: Flags [R.], seq 1, ack 1, win 13, options [nop,nop,TS val 2886617973 ecr 1201614448], length 0
  10:53:49.045241 IP 10.0.3.49.5000 > 10.100.4.222.38704: Flags [R.], seq 0, ack 2428474935, win 0, length 0
  ```

- `-PA<port list>`

  TCP ACK ping(host dicovery)

  ==注意该参数只针对 host dicovery 阶段，在 port scan 该发什么报文还是发什么报文，所以不能和 `-Pn` 一起使用，可以和 `-sn` 一起使用表示只做 ACK host discovery==

  This option sends an empty TCP packet with the TCP flag set

  使用 ACK 做探测包(==如果非 root 账号，会先发送 SYN 包==)，默认会使用 80 端口。`-PA` 和 `<port list>` 之间不能有空格，例如 `-PA22,3306,6000-7000`

  这里可以观察到 host discovery 阶段， Nmap 会使用 ACK 报文。但是 port scan 阶段，Nmap 还是会使用 SYN 报文

  ```
  $ sudo nmap -p22,5000 -PA22,5000 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 11:47 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00031s latency).
  
  PORT     STATE    SERVICE
  22/tcp   open     ssh
  5000/tcp filtered upnp
  
  Nmap done: 1 IP address (1 host up) scanned in 17.93 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  11:47:59.352615 IP 10.100.4.222.34795 > 10.0.3.49.22: Flags [.], ack 224338151, win 1024, length 0
  11:47:59.352628 IP 10.100.4.222.34795 > 10.0.3.49.5000: Flags [.], ack 224338151, win 1024, length 0
  11:47:59.352883 IP 10.0.3.49.22 > 10.100.4.222.34795: Flags [R], seq 224338151, win 0, length 0
  11:47:59.352913 IP 10.0.3.49.5000 > 10.100.4.222.34795: Flags [R], seq 224338151, win 0, length 0
  11:48:15.945868 IP 10.100.4.222.35051 > 10.0.3.49.22: Flags [S], seq 1041729868, win 1024, options [mss 1460], length 0
  11:48:15.945883 IP 10.100.4.222.35051 > 10.0.3.49.5000: Flags [S], seq 1041729868, win 1024, options [mss 1460], length 0
  11:48:15.946181 IP 10.0.3.49.22 > 10.100.4.222.35051: Flags [S.], seq 3776239515, ack 1041729869, win 29200, options [mss 1460], length 0
  11:48:15.946194 IP 10.100.4.222.35051 > 10.0.3.49.22: Flags [R], seq 1041729869, win 0, length 0
  11:48:17.047060 IP 10.100.4.222.35053 > 10.0.3.49.5000: Flags [S], seq 1041598798, win 1024, options [mss 1460], length 0
  ```

  同时提供 `-PS` 和 `-PA` 是为了最大程度的绕过防火墙。因为大多数人会对入向 SYN 包做过滤，同时出向不会过滤任何包。这时就可以使用 ACK 报文来探测主机是否存活（只会收到 RST 报文，因为这是一个畸形的连接）。

  例如在 10.0.3.49 中添加如下规则(过滤只含有 SYN flag，但是不包含 FIN,RST,ACK 的报文。所以为了最大程度的安全，应该使用 stateful 规则，在 iptables 中即使用 state match-extension)

  ```
  iptables -A INPUT -p tcp -m tcp --dport 5000 --tcp-flags FIN,SYN,RST,ACK SYN -j DROP
  ```

  然后使用分别使用 `sudo nmap -sn -PS5000 10.0.3.49`  和 `sudo nmap -sn -PA5000 10.0.3.49`

  ```
  $ sudo nmap -sn -PS5000 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 11:57 CST
  Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn
  Nmap done: 1 IP address (0 hosts up) scanned in 2.11 seconds
  
  $ sudo nmap -sn  -PA22,5000 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 11:51 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00028s latency).
  Nmap done: 1 IP address (1 host up) scanned in 11.13 seconds
  ```

  可以发现使用 `-PA` 探测，会被识别为 up host

- `-PU<port list>`

  UDP ping

  ==注意该参数只针对 host dicovery 阶段，在 port scan 该发什么报文还是发什么报文，所以不能和 `-Pn` 一起使用，可以和 `-sn` 一起使用表示只做 ACK host discovery==

  sends a UDP packet to the given ports

  使用 UDP 报文做探测，默认会使用 40125 端口,通常都是空报文。但是针对有些需要 payloads 的报文（SIP,HTTP3），可以通过 `--data`, `--data-string`, `--data-length` 来设置

  1. 当对端端口开放 UDP sokcet 时，UDP 按照 7 层协议，决定是否回包，大多数场景下不会回包
  2. 当对端端口关闭 UDP socket 时，会收到 ICMP port unreachable(这是由系统决定)

  如果没有收到回包，就认为 host donw，所以为了探测主机是否存活，应该尽量使用非常熟端口

  例如 在 10.0.3.49 使用 `nc -ulvk 5001 --exec cat` 监听 5001 UDP。然后使用 Nmap 的同时抓包

  ```
  sudo nmap -sn -PU5001  10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 12:50 CST
  Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn
  Nmap done: 1 IP address (0 hosts up) scanned in 2.14 seconds
  
  sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  12:51:50.595458 IP 10.100.4.222.62637 > 10.0.3.49.5001: UDP, length 0
  12:51:51.596483 IP 10.100.4.222.62639 > 10.0.3.49.5001: UDP, length 0
  ```

  这时 10.0.3.49 因为没有回包会被认为 host down

  如果使用 Nmap 扫描 5002 端口，就会被认为 host up，因为对应的端口没有开放，会回送 ICMP Port Unreachable

  ```
  $ sudo nmap -sn -PU5002  10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 12:56 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00038s latency).
  Nmap done: 1 IP address (1 host up) scanned in 11.18 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  12:56:08.078782 IP 10.100.4.222.35464 > 10.0.3.49.5002: UDP, length 0
  12:56:08.079126 IP 10.0.3.49 > 10.100.4.222: ICMP 10.0.3.49 udp port 5002 unreachable, length 36
  ```

- `-PE`

  ICMP echo request ping

  使用 ICMP type 8 echo request 做 host discovery，需要 root

  ```
  sudo nmap -sn -PE 10.0.3.49                         
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 14:07 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00033s latency).
  Nmap done: 1 IP address (1 host up) scanned in 11.12 seconds
  
  14:07:59.058393 IP 10.100.4.222 > 10.0.3.49: ICMP echo request, id 20917, seq 0, length 8
  14:07:59.058698 IP 10.0.3.49 > 10.100.4.222: ICMP echo reply, id 20917, seq 0, length 8
  ```

- `-PM`

  ICMP address mask request ping, 需要 root

  使用 ICMP type 17 address mask request 做 host discovery

  ```
  sudo nmap -sn -PM 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 14:11 CST
  Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn
  Nmap done: 1 IP address (0 hosts up) scanned in 2.14 seconds
  
  14:07:24.985199 IP 10.100.4.222 > 10.0.3.49: ICMP time stamp query id 17350 seq 0, length 20
  14:07:24.985520 IP 10.0.3.49 > 10.100.4.222: ICMP time stamp reply id 17350 seq 0: org 00:00:00.000, recv 06:07:25.004, xmit 06:07:25.004, length 20
  ```

- `-PP`

  ICMP timestamp query ping, 需要 root

  使用 ICMP type 13 timestamp 做 host discovery

  ```
  sudo nmap -sn -PP 10.0.3.49                         
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 14:07 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00036s latency).
  Nmap done: 1 IP address (1 host up) scanned in 16.61 seconds
  
  14:06:15.928480 IP 10.100.4.222 > 10.0.3.49: ICMP address mask request, length 12
  14:06:16.929503 IP 10.100.4.222 > 10.0.3.49: ICMP address mask request, length 12
  ```

- `--disable-arp-ping`

  Nmap 默认会做 ARP，可以使用该参数让 Nmap 不做 ARP

  在 ARP proxy 场景下非常有用

- `--discovery-ignore-rst`

  通常 Nmap 会将对端发送的 RST 作为判断 host up 的依据。但是 firewall 通常也能回送 RST，这就导致扫描的结果可能不准确。所以可以使用该参数忽略 RST 作为判断依据

- `--traceroute`

  探测的时候输出路由路径

  ```
  sudo nmap --traceroute -PS -sn -n 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 15:47 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00048s latency).
  
  TRACEROUTE (using port 80/tcp)
  HOP RTT     ADDRESS
  1   0.88 ms 10.100.4.1
  2   0.29 ms 10.0.3.49
  
  Nmap done: 1 IP address (1 host up) scanned in 0.27 seconds
  ```

### Port State

> 和 `nc` 中的状态不一样，在 `nc` 中如果 UDP 端口没有回包也会被记录为 connected sent successfully

Nmap 扫描出来一共有 6 种 port state。不同的 port scan 方式，对应的结果也有细微差别

1. open

   open means that an application on the target machine is listening for connections/packets on that port

   有应用在监听端口

   - 以 TCP 为例，即明确收到对端的 SYN-ACK
   - 以 UDP 为例，收到 UDP 的回包(是否回包和应用层的协议有关)

2. filtered

   Filtered means that a firewall, filter, or other network obstacle is blocking the port so that Nmap cannot tell whether it is open or closed.

   Nmap 无法判断端口是否有应用在监听，探测包可能被拦截过滤了

   - 以 TCP 为例，即没有收到对端的回包
   - 以 UDP 为例，即没有收到对端的回包
   - 或者收到 ICMP type 3 HOST UNRECHABLE || ICMP type 10 ADMINISTRATIVELY PROHIBITED

3. closed

   closed ports have no application listening on them, though they could open up at any time.

   没有应用在监听端口

   - 以 TCP 为例，即收到对端的 RESET
   - 以 UDP 为例，即收到对端的 ICMP DESTINATION PORT UNRECHABLE

4. unfiltered

   The unfiltered state means that a port is accessible,  but Nmap is unable to determine whether it is open or closed.

   Nmap 无法判断端口是否有应用在监听(但是对应 4 层网络是通的)

   - 以 TCP 为例，只会出现在发送畸形报文的场景中(例如 `-sA`)，收到对端的 RESET，并不能判断端口是 open 或者是 closed
   - 以 UDP 为例，目前尚无对应的场景

5. open|filtered

   Nmap 无法判断端口是 open 或者是 filtered

   - 以 TCP 为例，只会出现在发送畸形报文的场景中(例如 `-sN;-sF;-sX`)，没有收到对端报文，按照 RFC 793 的逻辑不能判断是 open 还是 filtered
   - 以 UDP 为例，目前尚无对应的场景

6. closed|filtered

   Nmap 无法判断端口是 closed 或者是 filtered

   - 以 TCP 为例
   - 以 UDP 为例

### Port scan

port scan 告诉 Nmap 该如何扫描端口，大多数和 port scan 相关的参数均需 root 权限(因为需要发送 raw packets)，且不能组合使用，除了 UDP scan(`-sU`) 和 SCTP scan `-sY | -sZ` 

下列 port scan option target 多数为 10.0.3.49，sshd 监听默认 22 端口，有如下规则

```
:INPUT ACCEPT [32:2164]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [18:1508]
-A INPUT -p tcp -m tcp --dport 5000 --tcp-flags FIN,SYN,RST,ACK SYN -j DROP
-A INPUT -p tcp -m tcp --dport 5001 --tcp-flags FIN,SYN,RST,ACK ACK -j DROP
```

如果没有指定任何 Port scan 参数，Nmap 默认会扫描常见的 1000 个 TCP 端口

- `-sS`

  TCP SYN Scan

  使用 SYN half-open 做端口扫描，Nmap 如果没有指定任何 port scan 参数默认使用 SYN half-open

  1. 当收到 SYN-ACK，端口会被标识为 open
  2. 当收到 RST，端口会被标识为 closed
  3. 如果没有收到报文或者收到 ICMP HOST UNREACHABLE，端口会被标识为 filtered

  ```
  $ sudo nmap -Pn -p22,5000,5001 -sS 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 14:32 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00034s latency).
  
  PORT     STATE    SERVICE
  22/tcp   open     ssh
  5000/tcp filtered upnp
  5001/tcp closed   commplex-link
  
  Nmap done: 1 IP address (1 host up) scanned in 17.85 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  14:32:30.284955 IP 10.100.4.222.49020 > 10.0.3.49.22: Flags [S], seq 2085337373, win 1024, options [mss 1460], length 0
  14:32:30.284972 IP 10.100.4.222.49020 > 10.0.3.49.5001: Flags [S], seq 2085337373, win 1024, options [mss 1460], length 0
  14:32:30.284978 IP 10.100.4.222.49020 > 10.0.3.49.5000: Flags [S], seq 2085337373, win 1024, options [mss 1460], length 0
  14:32:30.285265 IP 10.0.3.49.22 > 10.100.4.222.49020: Flags [S.], seq 2770108783, ack 2085337374, win 29200, options [mss 1460], length 0
  14:32:30.285266 IP 10.0.3.49.5001 > 10.100.4.222.49020: Flags [R.], seq 0, ack 2085337374, win 0, length 0
  14:32:30.285289 IP 10.100.4.222.49020 > 10.0.3.49.22: Flags [R], seq 2085337374, win 0, length 0
  14:32:31.386150 IP 10.100.4.222.49022 > 10.0.3.49.5000: Flags [S], seq 2085206303, win 1024, options [mss 1460], length 0
  ```

- `-sT`

  TCP conect scan

  逻辑上和 `-sS` 相同，不过是通过调用系统 `connect()` 函数实现

  当 TCP SYN scan 不可用时，默认会使用 TCP connect scan（通常在用户没有 root 权限的情况下出现）

  1. 当收到 SYN-ACK，端口会被标识为 open
  2. 当收到 RST，端口会被标识为 closed
  3. 如果没有收到报文或者收到 ICMP HOST UNREACHABLE，端口会被标识为 filtered

  ```
  $ sudo nmap -Pn -p22,5000,5001 -sT 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 14:39 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00039s latency).
  
  PORT     STATE    SERVICE
  22/tcp   open     ssh
  5000/tcp filtered upnp
  5001/tcp closed   commplex-link
  
  Nmap done: 1 IP address (1 host up) scanned in 12.21 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  14:39:43.743130 IP 10.100.4.222.44556 > 10.0.3.49.22: Flags [S], seq 299795472, win 24820, options [mss 1460,sackOK,TS val 2900172671 ecr 0,nop,wscale 11], length 0
  14:39:43.743154 IP 10.100.4.222.45928 > 10.0.3.49.5000: Flags [S], seq 2999989804, win 24820, options [mss 1460,sackOK,TS val 2900172671 ecr 0,nop,wscale 11], length 0
  14:39:43.743168 IP 10.100.4.222.37680 > 10.0.3.49.5001: Flags [S], seq 3682813473, win 24820, options [mss 1460,sackOK,TS val 2900172671 ecr 0,nop,wscale 11], length 0
  14:39:43.743450 IP 10.0.3.49.22 > 10.100.4.222.44556: Flags [S.], seq 3034796890, ack 299795473, win 28960, options [mss 1460,sackOK,TS val 1215169208 ecr 2900172671,nop,wscale 7], length 0
  14:39:43.743450 IP 10.0.3.49.5001 > 10.100.4.222.37680: Flags [R.], seq 0, ack 3682813474, win 0, length 0
  14:39:43.743481 IP 10.100.4.222.44556 > 10.0.3.49.22: Flags [.], ack 1, win 13, options [nop,nop,TS val 2900172671 ecr 1215169208], length 0
  14:39:43.743506 IP 10.100.4.222.44556 > 10.0.3.49.22: Flags [R.], seq 1, ack 1, win 13, options [nop,nop,TS val 2900172671 ecr 1215169208], length 0
  14:39:44.843285 IP 10.100.4.222.51676 > 10.0.3.49.5000: Flags [S], seq 2450660463, win 24820, options [mss 1460,sackOK,TS val 2900173771 ecr 0,nop,wscale 11], length 0
  ```

- `-sU`

  UDP scans

  使用 UDP 做端口扫描

  1. 当收到 ICMP type 3 PORT UNREACHABLE，端口会被标识为 closed
  2. 当收到 ICMP type 3 HOST UNREACHABLE，端口会被标识为 filtered
  3. 如果没有收到报文，端口会被标识为 open|filtered
  4. 如果收到对应的 UDP 回包（通常和应用层使用的协议有关），端口会被标识为 open

  针对一些特殊的端口 Nmap 会设置 payloads，例如 DNS(53)

  ```
  $ sudo nmap -Pn -sU -p 53 114.114.114.114
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 15:00 CST
  Nmap scan report for public1.114dns.com (114.114.114.114)
  Host is up.
  
  PORT   STATE         SERVICE
  53/udp open|filtered domain
  
  Nmap done: 1 IP address (1 host up) scanned in 13.24 seconds
  
  $ sudo tcpdump -nni enp4s0 host 114.114.114.114
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  15:00:30.291490 IP 10.100.4.222.35619 > 114.114.114.114.53: 6+ TXT CHAOS? version.bind. (30)
  15:00:30.291501 IP 10.100.4.222.35619 > 114.114.114.114.53: 0 stat [0q] (12)
  15:00:31.292505 IP 10.100.4.222.35621 > 114.114.114.114.53: 6+ TXT CHAOS? version.bind. (30)
  15:00:31.292519 IP 10.100.4.222.35621 > 114.114.114.114.53: 0 stat [0q] (12)
  ```

  为了让一些特定的 Service 回包，可以和 `--data`, `--data-string`, `--data-length` 一起使用

  ```
  
  ```

  在 UDP scan 的场景中还有一个问题，通常主机都会限制 ICMP 的回包速率，这也就导致实际的 port state 可能是不准确的

- `-sN;-sF;-sX`

  这 3 个 options 可以和 `--scanflags` 一起使用

  在 RFC 793 中讨论了如下内容

  *if the destination port state is closed, an incoming segment not containing a RST causes a RST to be sent in response. packets sent to open ports without the SYN,RST, or ACK bits set causes the destination drop the packets*

  即按照上述逻辑，探测包可以是

  1. 不包含任何 TCP flags，对应 `-sN`
  2. FIN，对应 `-SF`
  3. URG
  4. PUSH
  5. FIN-URG-PUSH，对应 `-sX`
  6. FIN/URG/PUSH 排列组合

  端口的状态有如下几种

  1. 收到 RST，端口被标识为 closed
  2. 没有收到回包，端口被标识为 open|filtered
  3. 收到 ICMP type 3 HOST UNREACHABLE，端口被标识为 filtered

  - `-sN`

    Do not set any bit of TCP flags(TCP flag header is 0)

    不使用任何 TCP flags 做端口扫描

    这里可以看到 22 端口是没有回任何包，这也就对应了 RFC 793 中的内容。得出 22 端口是 open|filtered 状态

    ```
    $ sudo nmap -Pn -sN -p22,5000,5001 10.0.3.49
    Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 16:27 CST
    Nmap scan report for 10.0.3.49
    Host is up (0.00036s latency).
    
    PORT     STATE         SERVICE
    22/tcp   open|filtered ssh
    5000/tcp closed        upnp
    5001/tcp closed        commplex-link
    
    Nmap done: 1 IP address (1 host up) scanned in 17.82 seconds
    
    $ sudo tcpdump -nnvvvi enp4s0 host 10.0.3.49
    tcpdump: listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
    16:28:14.680933 IP (tos 0x0, ttl 50, id 16204, offset 0, flags [none], proto TCP (6), length 40)
        10.100.4.222.52124 > 10.0.3.49.22: Flags [none], cksum 0x2033 (correct), seq 1218796263, win 1024, length 0
    16:28:14.680948 IP (tos 0x0, ttl 50, id 60853, offset 0, flags [none], proto TCP (6), length 40)
        10.100.4.222.52124 > 10.0.3.49.5001: Flags [none], cksum 0x0cc0 (correct), seq 1218796263, win 1024, length 0
    16:28:14.680953 IP (tos 0x0, ttl 50, id 1769, offset 0, flags [none], proto TCP (6), length 40)
        10.100.4.222.52124 > 10.0.3.49.5000: Flags [none], cksum 0x0cc1 (correct), seq 1218796263, win 1024, length 0
    16:28:14.681305 IP (tos 0x0, ttl 63, id 7560, offset 0, flags [DF], proto TCP (6), length 40)
        10.0.3.49.5000 > 10.100.4.222.52124: Flags [R.], cksum 0x10ad (correct), seq 0, ack 1218796263, win 0, length 0
    16:28:14.681337 IP (tos 0x0, ttl 63, id 7561, offset 0, flags [DF], proto TCP (6), length 40)
        10.0.3.49.5001 > 10.100.4.222.52124: Flags [R.], cksum 0x10ac (correct), seq 0, ack 1218796263, win 0, length 0
    16:28:15.782069 IP (tos 0x0, ttl 37, id 28041, offset 0, flags [none], proto TCP (6), length 40)
        10.100.4.222.52126 > 10.0.3.49.22: Flags [none], cksum 0x2031 (correct), seq 1218927333, win 1024, length 0
    ```

  - `-sF`

    TCP FIN scan

    逻辑同 `-sN`

  - `-sX`

    TCP FIN-PUSH-URG

    逻辑同 `-SN`

  ==这 3 个参数常用于 bypass stateful firewall 非常有用==

- `-sA`

  TCP ACK scan

  使用 TCP ACK 做端口扫描，因为是畸形的请求，只会有 2 种情况

  1. 没有收到报文 || ICMP HOST UNREACHABLE，端口被标识为 filtered
  2. 收到 RST，端口被标识为 unfiltered。因为光从畸形的连接报文返回的 RST 不能判断端口是否放开，只能判断 host up

  使用 Nmap 扫描 22,5000,5001 端口

  ```
  $ sudo nmap -Pn -sA -p22,5000,5001 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 15:44 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00035s latency).
  
  PORT     STATE      SERVICE
  22/tcp   unfiltered ssh
  5000/tcp unfiltered upnp
  5001/tcp filtered   commplex-link
  
  Nmap done: 1 IP address (1 host up) scanned in 12.30 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  15:44:22.511088 IP 10.100.4.222.33650 > 10.0.3.49.22: Flags [.], ack 67896714, win 1024, length 0
  15:44:22.511102 IP 10.100.4.222.33650 > 10.0.3.49.5001: Flags [.], ack 67896714, win 1024, length 0
  15:44:22.511109 IP 10.100.4.222.33650 > 10.0.3.49.5000: Flags [.], ack 67896714, win 1024, length 0
  15:44:22.511426 IP 10.0.3.49.22 > 10.100.4.222.33650: Flags [R], seq 67896714, win 0, length 0
  15:44:22.511427 IP 10.0.3.49.5000 > 10.100.4.222.33650: Flags [R], seq 67896714, win 0, length 0
  15:44:23.612286 IP 10.100.4.222.33652 > 10.0.3.49.5001: Flags [.], ack 68027784, win 1024, length 0
  ```

  多被用于猜测 firewall 的过滤机制

- `-sW`

  TCP Window Scan

  使用 TCP windows update 报文（实际上也是 ACK）对端口做扫描。在一些系统上，open port 会使用一个 positive window size(即使回送的是 RST)，而 closed port 只会使用 0 window size。所以可以从回送报文的 Window size 来判断端口是否是打开的，==同时因为和系统有关，所以结果并不是可靠的(Linux 上所有 RST 报文回送的 window size 均为 0，例子中的 target 就是 Linux OS)==

  1. 如果收到报文 window size == 0，端口被标识为 closed
  2. 如果收到报文 window size > 0, 端口被标识为 open
  3. 如果没有收到报文，端口被标识为 filtered

  ```
  $ sudo nmap -Pn -sW -p22,5000,5001 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 15:53 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00028s latency).
  
  PORT     STATE    SERVICE
  22/tcp   closed   ssh
  5000/tcp closed   upnp
  5001/tcp filtered commplex-link
  
  Nmap done: 1 IP address (1 host up) scanned in 12.32 seconds
  
  $ sudo tcpdump -nnvvvi enp4s0 host 10.0.3.49
  tcpdump: listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  15:53:16.924402 IP (tos 0x0, ttl 44, id 61295, offset 0, flags [none], proto TCP (6), length 40)
      10.100.4.222.33874 > 10.0.3.49.22: Flags [.], cksum 0x11f3 (correct), seq 0, ack 1821412470, win 1024, length 0
  15:53:16.924415 IP (tos 0x0, ttl 58, id 17523, offset 0, flags [none], proto TCP (6), length 40)
      10.100.4.222.33874 > 10.0.3.49.5000: Flags [.], cksum 0xfe80 (correct), seq 0, ack 1821412470, win 1024, length 0
  15:53:16.924421 IP (tos 0x0, ttl 42, id 37036, offset 0, flags [none], proto TCP (6), length 40)
      10.100.4.222.33874 > 10.0.3.49.5001: Flags [.], cksum 0xfe7f (correct), seq 0, ack 1821412470, win 1024, length 0
  15:53:16.924680 IP (tos 0x0, ttl 63, id 1564, offset 0, flags [DF], proto TCP (6), length 40)
      10.0.3.49.5000 > 10.100.4.222.33874: Flags [R], cksum 0x028d (correct), seq 1821412470, win 0, length 0
  15:53:16.924710 IP (tos 0x0, ttl 63, id 1565, offset 0, flags [DF], proto TCP (6), length 40)
      10.0.3.49.22 > 10.100.4.222.33874: Flags [R], cksum 0x15ff (correct), seq 1821412470, win 0, length 0
  15:53:18.024660 IP (tos 0x0, ttl 57, id 28953, offset 0, flags [none], proto TCP (6), length 40)
      10.100.4.222.33876 > 10.0.3.49.5001: Flags [.], cksum 0xfe7d (correct), seq 0, ack 1821543540, win 1024, length 0
  ```

- `-sM`

  Maimon scan

  使用 FIN-ACK 对端口扫描，逻辑和意图类似 `-sA` ，都是畸形的报文。不管端口实际是 open 还是 closed，只要收到 RST 均标识为 closed

  ```
  $ sudo nmap -Pn -sM -p22,5000,5001 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-28 16:10 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00030s latency).
  
  PORT     STATE  SERVICE
  22/tcp   closed ssh
  5000/tcp closed upnp
  5001/tcp closed commplex-link
  
  Nmap done: 1 IP address (1 host up) scanned in 11.14 seconds
  
  $ sudo tcpdump -nnvvvi enp4s0 host 10.0.3.49
  tcpdump: listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  16:11:02.410944 IP (tos 0x0, ttl 37, id 65473, offset 0, flags [none], proto TCP (6), length 40)
      10.100.4.222.62216 > 10.0.3.49.22: Flags [F.], cksum 0x94b8 (correct), seq 0, ack 2095942300, win 1024, length 0
  16:11:02.410957 IP (tos 0x0, ttl 54, id 45132, offset 0, flags [none], proto TCP (6), length 40)
      10.100.4.222.62216 > 10.0.3.49.5001: Flags [F.], cksum 0x8145 (correct), seq 0, ack 2095942300, win 1024, length 0
  16:11:02.410962 IP (tos 0x0, ttl 39, id 33001, offset 0, flags [none], proto TCP (6), length 40)
      10.100.4.222.62216 > 10.0.3.49.5000: Flags [F.], cksum 0x8146 (correct), seq 0, ack 2095942300, win 1024, length 0
  16:11:02.411251 IP (tos 0x0, ttl 63, id 61170, offset 0, flags [DF], proto TCP (6), length 40)
      10.0.3.49.5000 > 10.100.4.222.62216: Flags [R], cksum 0x8553 (correct), seq 2095942300, win 0, length 0
  16:11:02.411285 IP (tos 0x0, ttl 63, id 61171, offset 0, flags [DF], proto TCP (6), length 40)
      10.0.3.49.22 > 10.100.4.222.62216: Flags [R], cksum 0x98c5 (correct), seq 2095942300, win 0, length 0
  16:11:02.411285 IP (tos 0x0, ttl 63, id 61172, offset 0, flags [DF], proto TCP (6), length 40)
      10.0.3.49.5001 > 10.100.4.222.62216: Flags [R], cksum 0x8552 (correct), seq 2095942300, win 0, length 0
  ```

- `--scanflags <flags>` 

  Custom TCP Scan

  使用自定义的 TCP flags 做扫描(可以和其他的 port scan options 一起使用)，支持 2 种格式

  1. numberic flags

     和 tcpdump 中的逻辑相同，取 bit 位

     ```
     |C|E|U|A|P|R|S|F|
     |---------------|
     |0 0 0 0 0 0 1 0|
     |---------------|
     |7 6 5 4 3 2 1 0|
     ```

     例如 `--scanflags 9` 就对应 PUSH-FIN 

  2. symbolic name

     例如 `--scanflags SYNURG` 就对应 SYN-URG

- `-sI <zombie host>[:<probeport>]`

  在 zombie host 上对 target 做端口扫描(即不会暴露自己的真实 IP)[^4]

### Port Specification and Scan Order

port specification 告诉 Nmap 应该扫描那些端口（默认会扫描常熟端口），scan order 告诉 Nmap 应该按照什么顺序扫描端口

- `-p <port range>`

  This option specifies which ports you want to scan and overrides the default.

  port scan 时用的端口,如果没有指定默认会使用常熟端口，支持如下几种格式

  1. individual port number

     `-p 22`

  2. ranges seprated by a hyphen

     `-p 22-5000`

  3. ports seprated by a comma

     `-p 22,5000`

  4. 1 - 65535

     `-p-`

  5. port numbers for particular protocol

     `T:` for TCP

     `U:` for UDP

     `S:` for SCTP

     `P:` for IP Protocol

     `-p U:53,111,137,T:21-25,80,139,8080`
     
     常用于想要使用多协议对端口进行扫描

  如果想要同时扫描 TCP UDP，需要同时使用 Port scan 中关于 TCP 和 UDP 的扫描项，例如 `-sU -sA`

- `--exclude-ports <port range>`

  This option specifies which ports you do want Nmap to exclude

  port scan 时不需要扫描的端口，支持格式同 `-p`

- `-F`

  fast scan

  Nmap 默认会扫描 1000 个常见端口，使用该参数，扫描最常见的端口，数量缩小至 100

- `-r`

  don‘t randomize ports

  Nmap 默认会按照随时顺序扫描端口，可以使用改参数让 Nmap 顺序扫描端口

### Service and Version Detection

Nmap 会将端口按照 nmap-services 做映射，例如 22 对应 ssh，25 对应 smtp

```
$ sudo nmap -Pn -p22,25 10.0.3.49
Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-29 11:35 CST
Nmap scan report for 10.0.3.49
Host is up (0.00033s latency).

PORT   STATE  SERVICE
22/tcp open   ssh
25/tcp closed smtp

Nmap done: 1 IP address (1 host up) scanned in 11.10 seconds
```

但是端口实际不一定对应相关的 service，所以 Nmap 提供了一系列参数用于探测对应服务的详细信息。逻辑上就是让 4 层连接正常握手，让对端回送对应协议的报文

- `-sV`

  Version detection

  除了对端口扫描判断 open 与否，还对对应 service 做版本扫描 

  ```
  $ sudo nmap -Pn -p22 -sV 10.0.3.48
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-29 11:44 CST
  Nmap scan report for 10.0.3.48
  Host is up (0.00036s latency).
  
  PORT   STATE SERVICE VERSION
  22/tcp open  ssh     OpenSSH 7.4 (protocol 2.0)
  
  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
  Nmap done: 1 IP address (1 host up) scanned in 16.76 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.48
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  11:44:51.385034 IP 10.100.4.222.54414 > 10.0.3.48.22: Flags [S], seq 3872106157, win 1024, options [mss 1460], length 0
  11:44:51.385363 IP 10.0.3.48.22 > 10.100.4.222.54414: Flags [S.], seq 299212323, ack 3872106158, win 29200, options [mss 1460], length 0
  11:44:51.385390 IP 10.100.4.222.54414 > 10.0.3.48.22: Flags [R], seq 3872106158, win 0, length 0
  11:44:51.515998 IP 10.100.4.222.50272 > 10.0.3.48.22: Flags [S], seq 1416924615, win 24820, options [mss 1460,sackOK,TS val 2955693752 ecr 0,nop,wscale 11], length 0
  11:44:51.516316 IP 10.0.3.48.22 > 10.100.4.222.50272: Flags [S.], seq 103819107, ack 1416924616, win 28960, options [mss 1460,sackOK,TS val 1291077880 ecr 2955693752,nop,wscale 7], length 0
  11:44:51.516346 IP 10.100.4.222.50272 > 10.0.3.48.22: Flags [.], ack 1, win 13, options [nop,nop,TS val 2955693752 ecr 1291077880], length 0
  11:44:51.527783 IP 10.0.3.48.22 > 10.100.4.222.50272: Flags [P.], seq 1:22, ack 1, win 227, options [nop,nop,TS val 1291077892 ecr 2955693752], length 21: SSH: SSH-2.0-OpenSSH_7.4
  11:44:51.527794 IP 10.100.4.222.50272 > 10.0.3.48.22: Flags [.], ack 22, win 13, options [nop,nop,TS val 2955693763 ecr 1291077892], length 0
  11:44:51.528231 IP 10.100.4.222.50272 > 10.0.3.48.22: Flags [F.], seq 1, ack 22, win 13, options [nop,nop,TS val 2955693764 ecr 1291077892], length 0
  11:44:51.528652 IP 10.0.3.48.22 > 10.100.4.222.50272: Flags [.], ack 2, win 227, options [nop,nop,TS val 1291077893 ecr 2955693764], length 0
  11:44:51.529454 IP 10.0.3.48.22 > 10.100.4.222.50272: Flags [F.], seq 22, ack 2, win 227, options [nop,nop,TS val 1291077893 ecr 2955693764], length 0
  11:44:51.529465 IP 10.100.4.222.50272 > 10.0.3.48.22: Flags [.], ack 23, win 13, options [nop,nop,TS val 2955693765 ecr 1291077893], length 0
  ```

  还可以和 `-A` 一起使用，输出其他更加详细的信息

- `--version-intensity <intensity>`

  `-sV` 结果准确性。0-9，值越低准确性越低(通过发送的报文来实现)，扫描速度越快，默认为 7 通常无需设置，直接使用 `-sV` 即可

### OS Dection

Nmap 还可以根据回包的一些特征(ISN, TCP Options, IP ID, initial window size)，来判断 target OS OS 扫描

- `-O`

  Enable OS Detection

  ```
  $ sudo nmap -Pn -p22  -O 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-29 13:56 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00050s latency).
  
  PORT   STATE SERVICE
  22/tcp open  ssh
  Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
  Device type: general purpose
  Running: Linux 3.X|4.X
  OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
  OS details: Linux 3.2 - 4.9
  Network Distance: 2 hops
  
  OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .
  Nmap done: 1 IP address (1 host up) scanned in 12.40 seconds
  ```

  端口是否是 open 的可能会影响结果的准确性

  ```
  $ sudo nmap -Pn -p3389  -O 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-29 13:57 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00037s latency).
  
  PORT     STATE  SERVICE
  3389/tcp closed ms-wbt-server
  Too many fingerprints match this host to give specific OS details
  Network Distance: 2 hops
  
  OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .
  Nmap done: 1 IP address (1 host up) scanned in 12.58 seconds
  ```

  可以和 `-A` 一起使用，输出其他更加详细的信息

### Nmap Scripting Engine

Nmap Scripting Engine(NSE) 可以让用户通过 lua 脚本实现高度自定义化的扫描

### Timing and Performance

Nmap 在大面积扫描的过程中会不断发送探测包，一些防火墙可能会配置 rate limitation，导致一些探测包被丢弃而导致结果不可靠。这时就可以使用这些参数

time 相关的参数支持 unit

例如 下列均相同

```
--scan-delay 10000ms
--scan-delay 10
--scan-delay 10s
--scan-delay 0.1m
```

- `--min-hostgroup <numhosts>; --max-hostgroup <numhosts>`

  Adjust parallel scan group sizes. In general, larger groups are more efficient.  The downside is that host results can't be provided until the whole group is finished.

  Nmap 在并行 port scan 时(这两个参数对 host discovery 无效，host discovery 都在同组内执行)，会将 target hosts 分组，同一时间只对一组做扫描，需要等待这组 hosts 均扫描完，才会输出结果

  It starts out with a group size as low as five so the first results come quickly and then increases the groupsize to as high as 1024.  The exact default numbers depend on the options given.  For efficiency reasons, Nmap uses larger group sizes for UDP or few-port TCP scans.

  通常无需设置该参数

- `--min-parallelism <numprobes>; --max-parallelism <numprobes>`

  Adjust probe parallelization. These options control the total number of probes that may be outstanding for a host group.

  在单组内可以执行并行扫描，Nmap 会按照当前的网络会动态的设置该参数，通常无需设置该参数

- `--min-rtt-timeout <time>; --max-rtt-timeout <time>; --initial-rtt-timeout <time>`

  Adjust probe timeout

  port scan 回包 rtt 超时，Nmap 会动态设置，通常无需设置该参数

- `--max-retries <numretries>`

  Specify the maximum number of port scan probe retransmissions

  port scan 重传的次数，通常无需设置该参数

  如果 numretries 为 0，如果第一次探测端口是 filtered 就会直接标为 filtered, 不会再做第二次探测或者重传报文

- `--host-timeout <time>`

  Give up on slow target hosts

  在 port scan 阶段，针对单 host 扫描在 time 之后放弃扫描

  如果 time 为 0，表示不会 give up

- `--min-rate <number>; --max-rate <number>`

  Directly control the scanning rate

  限制 host discovery 和 port scan 的 packet rate(不对 OS/Service Dection 生效)，例如 `--min-rate 300` 表示 Nmap 会以至少 300 个报文每秒的速率发包

- `--scan-delay <time>;--max-scan-delay <time>`

  This option causes Nmap to wait at least the given amount of time between each probe it sends to a given host.

  指定每个 host 发包的间隔。例如

  同时并发发送 10.0.3.48 和 10.0.3.49 探测包

  在发送 10.0.3.48 22 端口探测包 5 sec 后，发送 10.0.3.48 5000 端口探测包

  在发送 10.0.3.49 22 端口探测包 5 sec 后，发送 10.0.3.49 5000 端口探测包

  ```
  $ sudo nmap --scan-delay 5s -Pn -p22,5000 10.0.3.48-49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-29 15:17 CST
  Nmap scan report for 10.0.3.48
  Host is up (0.00036s latency).
  
  PORT     STATE  SERVICE
  22/tcp   open   ssh
  5000/tcp closed upnp
  
  Nmap scan report for 10.0.3.49
  Host is up (0.00034s latency).
  
  PORT     STATE    SERVICE
  22/tcp   open     ssh
  5000/tcp filtered upnp
  
  Nmap done: 2 IP addresses (2 hosts up) scanned in 32.11 seconds
  
  $ sudo tcpdump -nni enp4s0 host 10.0.3.48 or 10.0.3.49
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
  15:18:06.830149 IP 10.100.4.222.41855 > 10.0.3.49.22: Flags [S], seq 435611863, win 1024, options [mss 1460], length 0
  15:18:06.830161 IP 10.100.4.222.41855 > 10.0.3.48.22: Flags [S], seq 435611863, win 1024, options [mss 1460], length 0
  15:18:06.830456 IP 10.0.3.49.22 > 10.100.4.222.41855: Flags [S.], seq 1635789788, ack 435611864, win 29200, options [mss 1460], length 0
  15:18:06.830478 IP 10.100.4.222.41855 > 10.0.3.49.22: Flags [R], seq 435611864, win 0, length 0
  15:18:06.830516 IP 10.0.3.48.22 > 10.100.4.222.41855: Flags [S.], seq 3570229452, ack 435611864, win 29200, options [mss 1460], length 0
  15:18:06.830522 IP 10.100.4.222.41855 > 10.0.3.48.22: Flags [R], seq 435611864, win 0, length 0
  15:18:11.835169 IP 10.100.4.222.41855 > 10.0.3.49.5000: Flags [S], seq 435611863, win 1024, options [mss 1460], length 0
  15:18:11.835185 IP 10.100.4.222.41855 > 10.0.3.48.5000: Flags [S], seq 435611863, win 1024, options [mss 1460], length 0
  15:18:11.835544 IP 10.0.3.48.5000 > 10.100.4.222.41855: Flags [R.], seq 0, ack 435611864, win 0, length 0
  15:18:17.841216 IP 10.100.4.222.41857 > 10.0.3.49.5000: Flags [S], seq 435480789, win 1024, options [mss 1460], length 0
  ```

- `-T paranoid|sneaky|polite|normal|aggressive|insane`

  Set a timing template

  除上述的参数外(上述参数会对 `-T` 等价的参数做 override)，Nmap 还提供了 6 套 timing template，用于不同的场景，扫描激进程度按照如下顺序增加(扫描时间按照如下顺序减少)

  1. paranoid(0) 激进程度最低，扫描时间最长。每隔 5 min 发一次包
  2. sneaky(1) 每隔 15 sec 发一次包
  3. polite(2) 每隔 0.4 sec 发一次包
  4. normal(3) 
  5. agressive(4) 每隔 10 ms 发一次包。等价于设置了`--max-rtt-timeout 1250ms  --min-rtt-timeout 100ms  --initial-rtt-timeout 500ms  --max-retries 6`
  6. isane(5) 激进程度最高，扫描时间最短。每隔 5 ms 发一次包。等价于设置了`--max-rtt-timeout 300ms  --min-rtt-timeout 50ms  --initial-rtt-timeout 250ms  --max-retries 2  --host-timeout 15m  --script-timeout 10m`

  paranoid 和 sneaky 用于规避 IDS(Intrusion Dection System)

  默认 normal，如果在网络较好的环境下，可以使用 `-T5` 加快扫描速度

  ```
  (base) cc in /opt λ sudo nmap -Pn -p22,3389  10.0.3.48
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-30 14:29 CST
  Nmap scan report for 10.0.3.48
  Host is up (0.00040s latency).
  
  PORT     STATE  SERVICE
  22/tcp   open   ssh
  3389/tcp closed ms-wbt-server
  
  Nmap done: 1 IP address (1 host up) scanned in 16.64 seconds
  
  (base) cc in /opt λ sudo nmap -Pn -p22,3389 -T5  10.0.3.48
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-30 14:29 CST
  Nmap scan report for 10.0.3.48
  Host is up (0.00041s latency).
  
  PORT     STATE  SERVICE
  22/tcp   open   ssh
  3389/tcp closed ms-wbt-server
  
  Nmap done: 1 IP address (1 host up) scanned in 11.13 seconds
  ```

  需要注意的一点是

  > Maximum UDP scan delay is not set by `T4` or `T5`, but it can be set with the `--max-scan-delay` option.

### Firewall/IDs Evasion and Spoofing

大多数公司都会在边界设置 IDS(intrusion detection systems) 或者 IPS(intrusion prevention systems)，用于过滤流量。为了应对 IDS 以及 IPS，Nmap 提供了一系列参数用于 bypass

- `-f ; --mtu <offset>`

  - `-f`

    fragment packets

    使用 tiny fragmented IP packets 做探测包（包括 host discovery 以及 port scan）。原始 TCP 报文（不带 3 层或者是 2 层头，但是包含 4 层头）会按照 8 byte 拆分

    例如使用如下 2 个命令并抓包(这里限制了 retries 次数，即 retransmission 次数,只发包一次)

    ```
    $ sudo nmap  -Pn -p22 -T5 --max-retries 0 10.0.3.49
    Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-30 16:26 CST
    Nmap scan report for 10.0.3.49
    Host is up (0.00034s latency).
    
    PORT   STATE SERVICE
    22/tcp open  ssh
    
    Nmap done: 1 IP address (1 host up) scanned in 11.14 seconds
    
    $ sudo nmap -f -Pn -p22 -T5 --max-retries 0 10.0.3.49
    Starting Nmap 7.94 ( https://nmap.org ) at 2024-04-30 16:20 CST
    Nmap scan report for 10.0.3.49
    Host is up.
    
    PORT   STATE    SERVICE
    22/tcp filtered ssh
    
    Nmap done: 1 IP address (1 host up) scanned in 11.62 seconds
    ```

    不知道是什么原因在 tcpdump 中分片的报文会被标识为 IPv6，这里在 wireshark 中打开

    ![](https://github.com/dhay3/picx-images-hosting/raw/master/20240430/2024-04-30_16-46_1.7ljsqd0tbi.png)

    1. #1-#3 不带 `-f`

       可以看到报文长度为 58 byte($tcp\ option\ mss\ 4 + tcp\ header\ 20 + IPv4\ header\ 20 + Ether\ header\ 14 $​​)

       TCP 部分 24 byte

    2. #4-#6 带 `-f`

       因为 TCP 部分为 24 byte，按照 8 byte 一组划分为 3 组

       #4 报文长度为 42 byte($IPv4\ Data\ 8 + IPv4\ header\ 20 + Ether\ header\ 14 $​)

       #5 报文长度为 42 byte($IPv4\ Data\ 8 + IPv4\ header\ 20 + Ether\ header\ 14 $)

       #6 报文长度为 42 byte($IPv4\ Data\ 8 + IPv4\ header\ 20 + Ether\ header\ 14 $​​) 报文在对端 Host 重组

  - `--mtu <offset>`

    指定分片大小，不能和 `-f` 一起使用，offset 必须是 8 的倍数

  
  实际测试发现不管用 `-f` 或者 `--mtu` 分片后的第一个报文会被丢弃(中间链路以及源目均无丢错包)，原因不明，导致对端不回包，被标识为 filtered

- `-D <decoy1>[,<decoy2>][,ME][...]`

  Cloak a scan with decoys

  诱饵扫描，伪造 IP 按照顺序发送请求，在 host discovery 和 scan port 中都生效

  decoy 也可以使用如下占位符

  - `ME` 代表本机 IP，如果没有指定 ME，Nmap 会将其插入到随机位置
  - `RND:<number>` 随即生成 number IP 用于诱饵扫描

  例如使用 Nmap 使用 decoy 10.0.3.75 和 10.0.3.48 对 10.0.3.49 扫描

  可以发现几点

  1. 所有 decoies 报文都是从 attacker 发出（探测报文 MAC 相同）

  2. target 收到 decoies 报文，会往实际对应 IP 主机回包（所以如果对应 IP 主机不是 up host，target 回包给对应 IP 主机就不会收到回包，从而消耗 target 资源，如果大量的 decoies 都不是 up host 就会对 target 造成 SYN flood）

     这里对 arp 的部分还有点疑惑

  ```
  $ sudo nmap -Pn -p22 -D 10.0.3.75,10.0.3.48,ME 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 11:02 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00037s latency).
  
  PORT   STATE SERVICE
  22/tcp open  ssh
  
  Nmap done: 1 IP address (1 host up) scanned in 11.12 seconds
  
  #attacker
  #本机 IP 10.100.4.222
  $ sudo tcpdump -nnei any host 10.0.3.49
  tcpdump: data link type LINUX_SLL2
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
  11:07:22.343733 enp4s0 Out ifindex 2 0a:32:24:f9:34:4a ethertype IPv4 (0x0800), length 64: 10.0.3.75.61965 > 10.0.3.49.22: Flags [S], seq 391656813, win 1024, options [mss 1460], length 0
  11:07:22.343749 enp4s0 Out ifindex 2 0a:32:24:f9:34:4a ethertype IPv4 (0x0800), length 64: 10.0.3.48.61965 > 10.0.3.49.22: Flags [S], seq 391656813, win 1024, options [mss 1460], length 0
  11:07:22.343755 enp4s0 Out ifindex 2 0a:32:24:f9:34:4a ethertype IPv4 (0x0800), length 64: 10.100.4.222.61965 > 10.0.3.49.22: Flags [S], seq 391656813, win 1024, options [mss 1460], length 0
  11:07:22.344053 enp4s0 In  ifindex 2 08:3a:38:6a:9c:4a ethertype IPv4 (0x0800), length 66: 10.0.3.49.22 > 10.100.4.222.61965: Flags [S.], seq 1112426840, ack 391656814, win 29200, options [mss 1460], length 0
  11:07:22.344080 enp4s0 Out ifindex 2 0a:32:24:f9:34:4a ethertype IPv4 (0x0800), length 60: 10.100.4.222.61965 > 10.0.3.49.22: Flags [R], seq 391656814, win 0, length 0
  
  #target
  $ sudo tcpdump -nnei any not arp
  11:07:22.337154  In 08:3a:38:6a:9c:64 ethertype IPv4 (0x0800), length 62: 10.0.3.75.61965 > 10.0.3.49.22: Flags [S], seq 391656813, win 1024, options [mss 1460], length 0
  11:07:22.337154  In 08:3a:38:6a:9c:64 ethertype IPv4 (0x0800), length 62: 10.0.3.48.61965 > 10.0.3.49.22: Flags [S], seq 391656813, win 1024, options [mss 1460], length 0
  11:07:22.337163  In 08:3a:38:6a:9c:64 ethertype IPv4 (0x0800), length 62: 10.100.4.222.61965 > 10.0.3.49.22: Flags [S], seq 391656813, win 1024, options [mss 1460], length 0
  11:07:22.337207 Out 00:50:56:91:91:e1 ethertype IPv4 (0x0800), length 60: 10.0.3.49.22 > 10.100.4.222.61965: Flags [S.], seq 1112426840, ack 391656814, win 29200, options [mss 1460], length 0
  11:07:22.337256 Out 00:50:56:91:91:e1 ethertype IPv4 (0x0800), length 60: 10.0.3.49.22 > 10.0.3.48.61965: Flags [S.], seq 2524148839, ack 391656814, win 29200, options [mss 1460], length 0
  11:07:22.337283 Out 00:50:56:91:91:e1 ethertype IPv4 (0x0800), length 60: 10.0.3.49.22 > 10.0.3.75.61965: Flags [S.], seq 1138970521, ack 391656814, win 29200, options [mss 1460], length 0
  11:07:22.337425  In 00:50:56:91:1e:74 ethertype IPv4 (0x0800), length 62: 10.0.3.75.61965 > 10.0.3.49.22: Flags [R], seq 391656814, win 0, length 0
  11:07:22.337469  In 08:3a:38:6a:9c:64 ethertype IPv4 (0x0800), length 62: 10.100.4.222.61965 > 10.0.3.49.22: Flags [R], seq 391656814, win 0, length 0
  11:07:22.337530  In 00:50:56:91:e0:27 ethertype IPv4 (0x0800), length 62: 10.0.3.48.61965 > 10.0.3.49.22: Flags [R], seq 391656814, win 0, length 0
  ```

- `-S <IP address>`

  Spoof source address

  使用指定的 IP 对 target 做探测，通常不需要手动指定

- `-e <interface>`

  Use specified interface

  使用指定的 iface 发送探测包，通常不需要手动指定

- `--source-port <portnumber>; -g <portnumber>`

  Spoof source port number

  从指定源端口发包

- `--data <hex string>`

  Append custom binary data to sent packets

  使用 hex data payload 发探测包

- `--data-string <string>`

  Append custom string to sent packets

  使用 string payload 发探测包

- `--data-length <number>`

  Append random data to sent packets

  使用随即内容 number byte payload 发探测包

- `--ttl <value>`

  Set IP time-to-live field

  使用指定 ttl 发包

- `--randomize-hosts`

  Randomize target host order

  使用随机顺序扫描 hosts

- `--spoof-mac <mac address,prefix,or vendor name>`

  Spoof MAC address

  使用伪造的 source MAC address 发包（如果 attacker 需要对 target 回包，回包的 source MAC address 是 attacker 实际的 MAC）

  ```
  $ sudo nmap -Pn -p22 -spoof-mac cisco  10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:15 CST
  Spoofing MAC address 00:00:0C:BB:F3:BB (Cisco Systems)
  Nmap scan report for 10.0.3.49
  Host is up (0.00037s latency).
  
  PORT   STATE SERVICE
  22/tcp open  ssh
  
  Nmap done: 1 IP address (1 host up) scanned in 11.18 seconds
  
  #attacker MAC 0a:32:24:f9:34:4a
  $ sudo tcpdump -nnei any host 10.0.3.49
  tcpdump: data link type LINUX_SLL2
  tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
  listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
  14:15:57.639264 enp4s0 Out ifindex 2 00:00:0c:bb:f3:bb ethertype IPv4 (0x0800), length 64: 10.100.4.222.60388 > 10.0.3.49.22: Flags [S], seq 3298102483, win 1024, options [mss 1460], length 0
  14:15:57.639611 enp4s0 In  ifindex 2 08:3a:38:6a:9c:4a ethertype IPv4 (0x0800), length 66: 10.0.3.49.22 > 10.100.4.222.60388: Flags [S.], seq 1976333158, ack 3298102484, win 29200, options [mss 1460], length 0
  14:15:57.639649 enp4s0 Out ifindex 2 0a:32:24:f9:34:4a ethertype IPv4 (0x0800), length 60: 10.100.4.222.60388 > 10.0.3.49.22: Flags [R], seq 3298102484, win 0, length 0
  ```

  支持如下几种格式

  1. 0

     Nmap 随机使用一个 MAC address

  2. mac address

     使用 48bit 按照 8bit 以冒号分隔的格式，例如 `--spoof-mac 01:02:03:04:05:06`

  3. vedor name

     使用一个指定 vendor 随机 MAC address，例如 `--spoof-mac cisco`

- `--proxies <comma-separted list of Proxy URL>`

  通过代理扫描

### Output

Nmap 提供了一组对输出内容相关的参数

- `-oN <filename>`

  将扫描的结果，输出到文件中

- `-oX <filename>`

  将扫描的结果,以 xml 的格式输出到 xml 中

- `-v | -v<level>`

  增加输出的详细程度（`-vv` 会默认使用 `--reason`，而 `-v` 不会）

  ```
   sudo nmap -Pn -p22 -spoof-mac cisco -n  -vv 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:41 CST
  Spoofing MAC address 00:00:0C:3A:7C:5A (Cisco Systems)
  Initiating SYN Stealth Scan at 14:41
  Scanning 10.0.3.49 [1 port]
  Discovered open port 22/tcp on 10.0.3.49
  Completed SYN Stealth Scan at 14:41, 0.04s elapsed (1 total ports)
  Nmap scan report for 10.0.3.49
  Host is up, received user-set (0.00041s latency).
  Scanned at 2024-05-06 14:41:56 CST for 0s
  
  PORT   STATE SERVICE REASON
  22/tcp open  ssh     syn-ack ttl 63
  
  Read data files from: /usr/bin/../share/nmap
  Nmap done: 1 IP address (1 host up) scanned in 0.13 seconds
             Raw packets sent: 1 (44B) | Rcvd: 1 (44B)
  ```

- `-d | -d<level>`

  进入 debug 模式（默认会使用 `--reason`），输出的内容比 `-v` 更加详细

  ```
   sudo nmap -Pn -p22 -spoof-mac cisco -n  -v -d 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:38 CST
  Spoofing MAC address 00:00:0C:0B:57:80 (Cisco Systems)
  --------------- Timing report ---------------
    hostgroups: min 1, max 100000
    rtt-timeouts: init 1000, min 100, max 10000
    max-scan-delay: TCP 1000, UDP 1000, SCTP 1000
    parallelism: min 0, max 0
    max-retries: 10, host-timeout: 0
    min-rate: 0, max-rate: 0
  ---------------------------------------------
  Initiating SYN Stealth Scan at 14:38
  Scanning 10.0.3.49 [1 port]
  Packet capture filter (device enp4s0): dst host 10.100.4.222 and (icmp or icmp6 or ((tcp) and (src host 10.0.3.49)))
  Discovered open port 22/tcp on 10.0.3.49
  Completed SYN Stealth Scan at 14:38, 0.05s elapsed (1 total ports)
  Overall sending rates: 21.17 packets / s, 931.51 bytes / s.
  Nmap scan report for 10.0.3.49
  Host is up, received user-set (0.00034s latency).
  Scanned at 2024-05-06 14:38:08 CST for 0s
  
  PORT   STATE SERVICE REASON
  22/tcp open  ssh     syn-ack ttl 63
  Final times for host: srtt: 342 rttvar: 5000  to: 100000
  
  Read from /usr/bin/../share/nmap: nmap-mac-prefixes nmap-protocols nmap-services.
  Nmap done: 1 IP address (1 host up) scanned in 0.15 seconds
             Raw packets sent: 1 (44B) | Rcvd: 1 (44B)
  ```

- `--reason`

  Shows the reason each port is set to a specific state and the reason each host is up or down.

  显示端口状态以及主机 up/down 的原因

  ```
  sudo nmap -Pn -p22 -spoof-mac cisco -n  --reason 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:39 CST
  Spoofing MAC address 00:00:0C:A0:2C:E1 (Cisco Systems)
  Nmap scan report for 10.0.3.49
  Host is up, received user-set (0.00034s latency).
  
  PORT   STATE SERVICE REASON
  22/tcp open  ssh     syn-ack ttl 63
  
  Nmap done: 1 IP address (1 host up) scanned in 0.14 seconds
  ```

- `--stats-every <time>`

  每隔 time 刷新一次扫描的结果，在大范围扫描中非常有用

  ```
   sudo nmap -Pn -p22 -spoof-mac cisco --stats-every 5  -v 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:43 CST
  Spoofing MAC address 00:00:0C:E5:0F:95 (Cisco Systems)
  Initiating Parallel DNS resolution of 1 host. at 14:43
  Stats: 0:00:05 elapsed; 0 hosts completed (0 up), 0 undergoing Host Discovery
  Parallel DNS resolution of 1 host. Timing: About 0.00% done
  Stats: 0:00:10 elapsed; 0 hosts completed (0 up), 0 undergoing Host Discovery
  Parallel DNS resolution of 1 host. Timing: About 0.00% done
  Stats: 0:00:15 elapsed; 0 hosts completed (0 up), 0 undergoing Host Discovery
  Parallel DNS resolution of 1 host. Timing: About 0.00% done
  Completed Parallel DNS resolution of 1 host. at 14:43, 16.50s elapsed
  Initiating SYN Stealth Scan at 14:43
  Scanning 10.0.3.49 [1 port]
  Discovered open port 22/tcp on 10.0.3.49
  Completed SYN Stealth Scan at 14:43, 0.05s elapsed (1 total ports)
  Nmap scan report for 10.0.3.49
  Host is up (0.00027s latency).
  
  PORT   STATE SERVICE
  22/tcp open  ssh
  
  Read data files from: /usr/bin/../share/nmap
  Nmap done: 1 IP address (1 host up) scanned in 16.65 seconds
             Raw packets sent: 1 (44B) | Rcvd: 1 (44B)
  ```

- `--packet-trace`

  输出 nmap 发送的每一个包的详情

  ```
  sudo nmap -Pn -p22 --packet-trace -n 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:56 CST
  SENT (0.0524s) TCP 10.100.4.222:36792 > 10.0.3.49:22 S ttl=51 id=35986 iplen=44  seq=1375012096 win=1024 <mss 1460>
  RCVD (0.0528s) TCP 10.0.3.49:22 > 10.100.4.222:36792 SA ttl=63 id=0 iplen=44  seq=2407063904 win=29200 <mss 1460>
  Nmap scan report for 10.0.3.49
  Host is up (0.00040s latency).
  
  PORT   STATE SERVICE
  22/tcp open  ssh
  
  Nmap done: 1 IP address (1 host up) scanned in 0.14 seconds
  ```

- `--open`

  Show only open (or possibly open) ports

  只输出 open 状态的端口，非常有用

  ```
  $ sudo nmap -Pn --open -n 10.0.3.49
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:59 CST
  Nmap scan report for 10.0.3.49
  Host is up (0.00028s latency).
  Not shown: 997 closed tcp ports (reset), 1 filtered tcp port (no-response)
  Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
  PORT     STATE SERVICE
  22/tcp   open  ssh
  3306/tcp open  mysql
  
  Nmap done: 1 IP address (1 host up) scanned in 1.33 seconds
  ```

- `--iflist`

  输出所有的 interfaces 以及 routes

  ```
   sudo nmap --iflist
  Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 14:56 CST
  ************************INTERFACES************************
  DEV             (SHORT)           IP/MASK                      TYPE     UP MTU   MAC
  **************************ROUTES**************************
  DST/MASK                      DEV             METRIC GATEWAY
  10.100.4.0/24                 enp4s0          100
  ```

### Miscellaneous Options

- `-A`

  等价于 `-O -sV -sC --traceroute`

### Runtime Interaction

在执行 Nmap 的过程中，还支持类似 `top` interactive 参数，可以使用 `?` 查看具体参数的内容

```
sudo nmap -Pn --open  10.0.3.49
Starting Nmap 7.94 ( https://nmap.org ) at 2024-05-06 15:11 CST
Interactive keyboard commands:
?               Display this information
v/V             Increase/decrease verbosity
d/D             Increase/decrease debugging
p/P             Enable/disable packet tracing
anything else   Print status
More help: https://nmap.org/book/man-runtime-interaction.html
```

输出任何内容可以查看扫描当前的状态

### Examples

具体例子查看官方文档[^5]

**references**

[^1]:https://nmap.org/book/toc.html
[^2]:https://nmap.org/book/nmap-overview-and-demos.html
[^3]:https://nmap.org/book/man.html
[^4]:https://nmap.org/book/idlescan.html
[^5]:https://nmap.org/book/man-examples.html