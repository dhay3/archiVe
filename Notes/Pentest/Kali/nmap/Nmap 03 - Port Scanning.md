# Nmap 03 - Port Scanning

## 0x01 Overview

当你使用 `nmap <target>` 时，nmap 会扫描常见的 1000 个 TCP 端口，并按照状态将端口划分为 6 种状态

1. open

   An application is actively accepting TCP  connections or UDP packets on this port.  Finding these is often the  primary goal of port scanning.  Security-minded people know that  each open port is an avenue for attack.  Attackers and pen-testers  want to exploit the open ports, while administrators try to close or  protect them with firewalls without thwarting legitimate users.  Open ports are also interesting for non-security scans because they  show services available for use on the network.  Before you get too  excited about an open port, note that it is possible that the  application is protected with a TCP wrapper  (tcpd) or that the application itself is  configured to only service approved client IP addresses.  Such cases  still leave more attack surface than a closed  port.

2. closed

   A closed port is accessible (it receives and  responds to Nmap probe packets), but there is no application  listening on it.  They can be helpful in showing that a host is  online and using an IP address (host discovery, or ping scanning),  and as part of OS detection.  Because closed ports are reachable,  they may be worth scanning later in case some open up.  Administrators may want to consider blocking such ports with a  firewall so they appear in the filtered state, discussed next.

3. filtered

   Nmap cannot determine whether the port is open  because packet filtering prevents its probes from reaching the port.  The filtering could be from a dedicated firewall device, router  rules, or host-based firewall software.  These ports frustrate  attackers because they provide so little information.  Sometimes  they respond with ICMP error messages such as type 3 code 13  (destination unreachable: communication administratively  prohibited), but filters that simply drop probes without responding  are far more common.  This forces Nmap to retry several times just  in case the probe was dropped due to network congestion rather than  filtering.  This sort of filtering slows scans down dramatically.

4. unfiltered

   The unfiltered state means that a port is accessible,  but Nmap is unable to determine whether it is open or closed.  Only  the ACK scan, which is used to map firewall rulesets, classifies  ports into this state.  Scanning unfiltered ports with other scan  types such as Window scan, SYN scan, or FIN scan, may help resolve  whether the port is open.  

5. open|filtered

   Nmap places ports in this state when it is unable to  determine whether a port is open or filtered.  This occurs for scan  types in which open ports give no response.  The lack of  response could also mean that a packet filter dropped the probe or  any response it elicited.  So Nmap does not know for sure whether  the port is open or being filtered.  The UDP, IP protocol,  FIN, NULL, and Xmas scans classify ports this  way.

6. closed|filterted

   This state is used when Nmap is unable to determine  whether a port is closed or filtered.  It is only used for the IP ID  Idle scan discussed in [the section called “TCP Idle Scan (`-sI`)”](https://nmap.org/book/idlescan.html).  

## 0x02 nmap-services

Nmap 提供了 `/usr/share/nmap/nmap-service ` 文件，记录了所有常熟端口，也可以使用 iana 提供的在线服务 http://www.iana.org/assignments/port-numbers

## 0x03 Tutorial of port scan

使用 Nmap 最简单的就是直接运行 `nmap <target>` ，这时 Nmap 会执行如下步骤

1. Converts *`<target>`* from a hostname into an IPv4 address using DNS.  If an IP address is specified instead of a hostname this lookup is skipped.

2. Pings the host, by default with an ICMP echo request packet and a TCP ACK packet to port 80, to determine whether it is up and running.  If not, Nmap reports that fact and exits.  I could have specified `-Pn` to skip this test.  See [Chapter 3, *Host Discovery (“Ping Scanning”)*](https://nmap.org/book/host-discovery.html).

3. Converts the target IP address back to the name using a reverse-DNS query.  Because of the way DNS works, the reverse name may not be the same as the *`<target>`* specified on the command-line.  This query can be skipped with the `-n` option to improve speed and stealthiness.

4. 

   Launches a TCP port scan of the most popular 1,000 ports listed in `nmap-services`.  A SYN stealth scan is usually used, but connect scan is substituted instead for non-root Unix users who lack the privileges necessary to send raw packets.

5. Prints the results to standard output in normal human-readable format, and exits.  Other output formats and locations (files) can be specified, as described in [Chapter 13, *Nmap Output Formats*](https://nmap.org/book/output.html). [Example 4.2](https://nmap.org/book/port-scanning-tutorial.html#port-scanning-tutorial-nmap1) displays the results when scanme.nmap.org is used as *`<target>`*.

例如

```
# nmap scanme.nmap.org

Starting Nmap ( https://nmap.org )
Nmap scan report for scanme.nmap.org (64.13.134.52)
Not shown: 994 filtered ports
PORT    STATE  SERVICE
22/tcp  open   ssh
25/tcp  closed smtp
53/tcp  open   domain
70/tcp  closed gopher
80/tcp  open   http
113/tcp closed auth

Nmap done: 1 IP address (1 host up) scanned in 4.99 seconds
```

1. 第一行显示 Nmap 的下载地址
2. 地二行显示 target IP address 以及 reverse DNS name(PTR record)
3. 第三行显示 被过滤掉的 filtered 状态的端口
4. 第四行部分显示 ports table，具体的 column headers 根据参数显示。如果对应的端口不再 nmap-services 中就会被标记为 unkown
5. 最后一样显示 host discovery 发现的 up host，以及 nmap 扫描整个过程中的耗时

**references**

[^1]:https://nmap.org/book/port-scanning.html