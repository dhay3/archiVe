# Switch

## Digest

交换机用于连接同一网络的多种设备(可以直接理解成多端口的网桥)。主要工作在 L2，使用MAC地址转发数据。

通过引入路由功能，也可以在网络层转发数据，这种交换机也被称为3层交换机(目前大部分商用的都是3层交换机)。除此以外还有高层的交换机具体可以参考wikipedia
[![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/23156369/1655302287175-df066b0f-793a-44c1-88c3-ebacb3dbe0ef.png#clientId=u4f7d3328-d775-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=Ib35t&margin=%5Bobject%20Object%5D&originHeight=114&originWidth=555&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u01c4fc4b-c047-4dac-a63d-a1d096fbda0&title=)](https://camo.githubusercontent.com/d14e0afe6e2f646ac41565a7a7671c037d4bbb0b01ba656ce811fbac2b52482a/68747470733a2f2f63646e2e6a7364656c6976722e6e65742f67682f64686179332f696d6167652d7265706f406d61737465722f32303231303630312f323032312d30392d30365f31322d30312e34666469686c716f346e71302e706e67)

## Principle

交换机中有一张MAC地址转发表，记录了MAC地址和交换机端口的对应关系。这就使得交换机具备多级级联的能力，每个交换机在转发报文的时候只需要知道这个目的MAC可以从我的哪一个端口到达就行了，然后就把帧往这个端口发，至于后面的设备怎么处理他并不关心。就这样一级一级转发，直到电脑的网卡实际连接的交换机把帧发到网卡以后，网卡一看目的MAC就是自己，然后就解封装，交由三层协议栈进行处理。
以上是转发表和转发的过程，那么另外一个关键的问题是交换机的这张MAC地址表是怎么建立的，部分是根据主动发起请求的报文，把源MAC和从哪一个端口收到的建立对应，另一部分在收到报文的时候如果MAC表里还没有这个目的MAC，那么就在除了收到这个报文的端口以外的其他端口进行一次泛洪(这可能会导致网络拥塞)。网络中的其他设备也同样会泛洪(但是路由器不会，因为路由会划分数据链路层广播域)，等待目的MAC的终端响应。
因为交换机对数据包的转发是建立在MAC地址的，对于IP协议来说它是透明的。即交换机在转发数据包时，不知道也无须知道源目IP，只需要知道物理地址就行。由于处理比较简单(不需要解封装)，所以处理比较快
具体处理数据帧的流量参考以下

- 收到某网段（设为A）MAC地址为X的计算机发给MAC地址为Y的计算机的数据包。交换机从而记下了MAC地址X在网段A。这称为学习（learning）。
- 交换机还不知道MAC地址Y在哪个网段上，于是向除了A以外的所有网段转发该数据包。这称为泛洪（flooding）。
- MAC地址Y的计算机收到该数据包，向MAC地址X发出确认包。交换机收到该包后，从而记录下MAC地址Y所在的网段。
- 交换机向MAC地址X转发确认包。这称为转发（forwarding）。
- 交换机收到一个数据包，查表后发现该数据包的来源地址与目的地址属于同一网段。交换机将不处理该数据包。这称为过滤（filtering）。==直接建立peer to peer==
- 交换机内部的MAC地址-网段查询表的每条记录采用时间戳记录最后一次访问的时间。早于某个阈值（用户可配置）的记录被清除。这称为老化（aging）。